# 邪雀 Xtreme Mahjong - 実装TODOリスト

## 実装済み ✅

### フェーズ1: コアロジックとCUIプロトタイプ（完了: 2025-11-17）

- [x] Rustで麻雀コアライブラリを実装
  - [x] 牌システム（数牌・字牌・赤ドラ）
  - [x] 手牌管理（副露、自動ソート）
  - [x] プレイヤー管理（点数、河）
  - [x] ゲーム進行（配牌、山牌、ドラ、ターン管理）
  - [x] 基本的な点数計算
- [x] CUIクライアントの作成
  - [x] ターミナルUI
  - [x] プレイヤー入力処理
  - [x] CPU対戦機能（シンプル）
  - [x] ゲーム状態表示
- [x] 単体テスト実装
- [x] ビルド環境整備

### コアゲーム機能の完成（完了: 2025-11-17）

- [x] 和了判定の完全実装
  - [x] 4面子1雀頭の判定アルゴリズム
  - [x] 七対子形の判定
  - [x] 国士無双形の判定
  - [x] シャンテン数計算
- [x] 役判定の完全実装
  - [x] 一飜役（タンヤオ、ピンフ、役牌、ツモ、一盃口）
  - [x] 二飜役（七対子、対々和、三暗刻、混一色）
  - [x] 三飜役以上（二盃口、純チャン、混一色）
  - [x] 六飜役（清一色）
  - [x] 役満（国士無双、四暗刻、大三元、字一色、緑一色、清老頭、九蓮宝燈）
- [x] AIエンジンの実装
  - [x] レベル1: ランダム打牌
  - [x] レベル2: 孤立牌優先
  - [x] レベル3: シャンテン数ベース
- [x] 副露システムの実装
  - [x] チー判定・実行
  - [x] ポン判定・実行
  - [x] カン判定・実行（明槓・暗槓）
  - [x] 槓ドラの追加
- [x] リーチシステムの実装
  - [x] リーチ判定
  - [x] リーチ宣言処理
  - [x] 供託管理
  - [x] 一発フラグ管理
  - [x] リーチ後の打牌制限

### フェーズ2: Nostr P2P通信基盤（進行中）

- [x] Nostr基本構造の実装
  - [x] NostrKeys構造体（鍵管理）
  - [x] GameEvent構造体（ゲームイベント）
  - [x] NostrClient基本構造
  - [x] イベントタイプの定義
- [ ] Nostrクライアント機能の実装
  - [ ] 実際のnostr-sdk統合
  - [ ] 鍵の永続化
  - [ ] リレー接続機能
- [ ] マッチングシステムの実装
  - [ ] 対戦募集イベントの送信
  - [ ] 募集イベントの購読・表示
  - [ ] 参加応答の送受信
  - [ ] 4人マッチング成立判定

---

## 優先度1: コアゲーム機能の完成 🔥 ✅ COMPLETED

### 1.1 役判定の完全実装【HIGH】

**目的**: 現在タンヤオ・ピンフ・役牌のみ実装されているため、全役を実装する

#### タスク:
- [ ] 一飜役の実装
  - [ ] リーチ（立直）
  - [ ] 一発
  - [ ] 門前清自摸和（メンゼンツモ）
  - [ ] 槍槓（チャンカン）
  - [ ] 嶺上開花（リンシャンカイホウ）
  - [ ] 海底摸月（ハイテイモーユエ）
  - [ ] 河底撈魚（ホウテイラオユイ）
  - [ ] ダブル立直
  - [ ] イーペーコー（一盃口）

- [ ] 二飜役の実装
  - [ ] 三色同順（サンシキドウジュン）
  - [ ] 一気通貫（イッキツウカン）
  - [ ] 混全帯么九（チャンタ）
  - [ ] 七対子（チートイツ）
  - [ ] 対々和（トイトイホー）
  - [ ] 三暗刻（サンアンコウ）
  - [ ] 三色同刻（サンシキドウコウ）
  - [ ] 三槓子（サンカンツ）
  - [ ] 小三元（ショウサンゲン）
  - [ ] ダブル東・ダブル南等（連風牌）

- [ ] 三飜役以上の実装
  - [ ] 混一色（ホンイーソー）- 3飜
  - [ ] 純全帯么九（ジュンチャン）- 3飜
  - [ ] 二盃口（リャンペーコー）- 3飜
  - [ ] 清一色（チンイーソー）- 6飜

- [ ] 役満の実装
  - [ ] 国士無双（コクシムソウ）
  - [ ] 四暗刻（スーアンコウ）
  - [ ] 大三元（ダイサンゲン）
  - [ ] 字一色（ツーイーソー）
  - [ ] 小四喜（ショウスーシー）
  - [ ] 大四喜（ダイスーシー）
  - [ ] 緑一色（リューイーソー）
  - [ ] 清老頭（チンロウトウ）
  - [ ] 九蓮宝燈（チューレンポウトウ）
  - [ ] 四槓子（スーカンツ）
  - [ ] 天和（テンホウ）
  - [ ] 地和（チーホウ）

**ファイル**: `src/scoring.rs`

### 1.2 和了判定の完全実装【HIGH】

**目的**: 現在の簡易的な和了判定を、正確な面子構成判定に置き換える

#### タスク:
- [ ] 4面子1雀頭の判定アルゴリズム実装
- [ ] 七対子形の判定
- [ ] 国士無双形の判定
- [ ] 待ち形の判定（両面、嵌張、辺張、単騎、双碰、etc.）
- [ ] テンパイ判定の正確な実装
- [ ] シャンテン数計算

**ファイル**: `src/hand.rs`, `src/scoring.rs`

### 1.3 鳴き（副露）システムの完全実装【MEDIUM】

**目的**: チー・ポン・カンの完全な実装

#### タスク:
- [ ] チー判定と実行
- [ ] ポン判定と実行
- [ ] カン判定と実行
  - [ ] 明槓（ミンカン）
  - [ ] 暗槓（アンカン）
  - [ ] 加槓（カカン）
- [ ] 槓ドラの追加処理
- [ ] 鳴き後の打牌制限
- [ ] UI/UXへの統合

**ファイル**: `src/game.rs`, `src/hand.rs`, `src/main.rs`

### 1.4 リーチシステムの実装【MEDIUM】

**目的**: リーチの宣言と管理

#### タスク:
- [ ] リーチ判定（門前、テンパイ、1000点以上）
- [ ] リーチ宣言処理
- [ ] リーチ後の打牌制限（ツモ切りのみ）
- [ ] 供託の管理
- [ ] 一発フラグの管理

**ファイル**: `src/player.rs`, `src/game.rs`

### 1.5 AI思考エンジンの改善【MEDIUM】

**目的**: 現在「最初の牌を打つ」だけのCPUを改善

#### タスク:
- [ ] レベル1: ランダム打牌
- [ ] レベル2: 孤立牌優先打
- [ ] レベル3: 向聴数計算ベース
- [ ] レベル4: 期待値計算ベース
- [ ] 公平性の確保（盗み見禁止の徹底）

**ファイル**: `src/ai.rs`（新規作成）

---

## 優先度2: Nostr P2P通信基盤【P2P】

### 2.1 Nostr基盤の構築【HIGH】

#### タスク:
- [ ] nostr-sdk依存関係の追加
- [ ] Nostr鍵ペア生成・管理
- [ ] ローカルストレージへの鍵保存
- [ ] Nostrリレー接続機能
- [ ] イベント送信・購読機能
- [ ] ゲームイベント用kindとtagsの設計

**ファイル**: `src/nostr.rs`（新規作成）, `Cargo.toml`

### 2.2 マッチングシステム【HIGH】

#### タスク:
- [ ] 対戦募集イベントの送信
- [ ] 募集イベントの購読・表示
- [ ] 参加応答の送受信
- [ ] 4人マッチング成立判定
- [ ] マッチング成立通知

**ファイル**: `src/matchmaking.rs`（新規作成）

### 2.3 WebRTCシグナリング【MEDIUM】

#### タスク:
- [ ] SDP（Session Description Protocol）の交換
- [ ] ICE Candidateの交換
- [ ] Nostr経由でのシグナリング情報の送受信
- [ ] P2P接続確立の確認

**ファイル**: `src/webrtc_signaling.rs`（新規作成）

### 2.4 CUI P2P対戦プロトタイプ【MEDIUM】

#### タスク:
- [ ] Nostr経由での打牌情報の同期
- [ ] 2クライアント間での対戦テスト
- [ ] 4クライアント間での対戦テスト
- [ ] 切断・再接続処理

**ファイル**: `src/main.rs`, `src/network.rs`（新規作成）

---

## 優先度3: Web版クライアント開発【WEB】

### 3.1 WASM環境構築【HIGH】

#### タスク:
- [ ] wasm-bindgen依存関係の追加
- [ ] WASMビルド設定
- [ ] WASM用APIラッパーの作成
- [ ] ビルドスクリプトの作成
- [ ] 動作確認（Hello World）

**ファイル**: `Cargo.toml`, `src/wasm.rs`（新規作成）, `build.sh`

### 3.2 Webフロントエンド基盤【HIGH】

#### タスク:
- [ ] TypeScript + Vite環境構築
- [ ] UIフレームワーク選定（React/Svelte/Vue）
- [ ] WASM読み込み・初期化
- [ ] 基本的なレイアウト作成

**ディレクトリ**: `web/`（新規作成）

### 3.3 WebUI実装【MEDIUM】

#### タスク:
- [ ] 麻雀卓の表示
- [ ] 手牌の表示
- [ ] 牌の画像アセット作成or取得
- [ ] クリック操作での打牌
- [ ] 河（捨て牌）の表示
- [ ] 点数・ドラ表示
- [ ] ログ・チャットエリア

**ディレクトリ**: `web/src/components/`

### 3.4 Web版CPU対戦【MEDIUM】

#### タスク:
- [ ] WASM経由でのゲームロジック呼び出し
- [ ] ブラウザ上での対戦動作確認
- [ ] アニメーション効果の追加

**ディレクトリ**: `web/src/`

---

## 優先度4: Web版P2P対戦【ONLINE】

### 4.1 Nostr Web統合【HIGH】

#### タスク:
- [ ] nostr-tools (TypeScript) の導入
- [ ] ブラウザでの鍵生成・管理
- [ ] IndexedDB/LocalStorageへの保存
- [ ] Nostrリレー接続（WebSocket）
- [ ] マッチングUIの実装

**ディレクトリ**: `web/src/nostr/`

### 4.2 WebRTC P2P通信【HIGH】

#### タスク:
- [ ] WebRTC DataChannel実装
- [ ] Nostr経由シグナリング
- [ ] 4人P2P接続の確立
- [ ] メッシュトポロジーの実装
- [ ] 接続品質モニタリング

**ディレクトリ**: `web/src/webrtc/`

### 4.3 ゲーム状態同期【HIGH】

#### タスク:
- [ ] 打牌イベントのP2P送信
- [ ] 受信イベントの検証
- [ ] 状態の一貫性チェック
- [ ] 不正検出・対応

**ディレクトリ**: `web/src/sync/`

### 4.4 オンライン対戦完成【MEDIUM】

#### タスク:
- [ ] 4人オンライン対戦のフルテスト
- [ ] エラーハンドリング
- [ ] タイムアウト処理
- [ ] 切断時の対応

---

## 優先度5: 特殊ルール実装【SPECIAL】

### 5.1 鷲巣麻雀【MEDIUM】

#### タスク:
- [ ] ガラス牌システム（3/4透明）
- [ ] 血液ポイントシステム
- [ ] UI表示の実装
- [ ] ルール説明の追加

**ファイル**: `src/special_rules/washizu.rs`（新規作成）

### 5.2 誠京麻雀【MEDIUM】

#### タスク:
- [ ] 場代システム
- [ ] 二度ヅモルール
- [ ] 役満祝儀ルール
- [ ] UI表示の実装

**ファイル**: `src/special_rules/seikyo.rs`（新規作成）

### 5.3 闇麻【LOW】

#### タスク:
- [ ] 闇牌システム（打牌隠蔽）
- [ ] 照射システム（看破）
- [ ] ポイント支払い管理
- [ ] UI表示の実装

**ファイル**: `src/special_rules/yami.rs`（新規作成）

### 5.4 リアルタイム麻雀【LOW】

#### タスク:
- [ ] 同時打牌システム
- [ ] 早い者勝ち判定（ロン > ポン > チー）
- [ ] タイムアウト自動ツモ切り
- [ ] リアルタイムUI
- [ ] P2P低遅延最適化

**ファイル**: `src/special_rules/realtime.rs`（新規作成）

---

## 優先度6: 追加機能【FEATURE】

### 6.1 観戦モード【LOW】

#### タスク:
- [ ] 観戦者としての接続
- [ ] 読み取り専用の状態受信
- [ ] 観戦UI
- [ ] コメント機能

### 6.2 戦績・ランキング【LOW】

#### タスク:
- [ ] 対戦結果のNostr記録
- [ ] 戦績の集計
- [ ] グローバルランキング表示
- [ ] 個人戦績表示

### 6.3 リプレイ機能【LOW】

#### タスク:
- [ ] 対戦ログの記録
- [ ] リプレイ再生機能
- [ ] 牌譜の出力・読み込み

---

## テスト・品質【QA】

### テスト強化

- [ ] ユニットテストのカバレッジ向上（目標80%）
- [ ] 統合テストの追加
- [ ] E2Eテストの作成
- [ ] パフォーマンステスト

### ドキュメント

- [ ] README.mdの充実
- [ ] API仕様書の作成
- [ ] ユーザーマニュアルの作成
- [ ] 開発者ガイドの作成

---

## インフラ・運用【INFRA】

- [ ] CI/CDパイプライン構築（GitHub Actions）
- [ ] Nostr専用リレーの構築・運用
- [ ] Web版のホスティング（GitHub Pages or Vercel）
- [ ] ドメイン取得

---

## 実装の優先順位まとめ

1. **優先度1 (コアゲーム機能)** - 現在のゲームを完全に遊べる状態にする
2. **優先度2 (Nostr P2P基盤)** - オンライン対戦の基礎を作る
3. **優先度3 (Web版開発)** - ブラウザで遊べるようにする
4. **優先度4 (Web P2P対戦)** - オンライン対戦を完成させる
5. **優先度5 (特殊ルール)** - ゲームの独自性を実装
6. **優先度6 (追加機能)** - UX向上と付加価値

---

## 次のアクション

**即座に着手すべきタスク**:

1. 役判定の完全実装 (`src/scoring.rs`)
2. 和了判定の完全実装 (`src/hand.rs`)
3. AI思考エンジンの作成 (`src/ai.rs`)

これらが完了すれば、まともな麻雀ゲームとして遊べるようになります。
