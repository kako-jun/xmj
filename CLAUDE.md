# GEMINI.md: 邪雀 Xtreme Mahjong (xmj) 開発ドキュメント

## 1. 要件定義 (Requirements)

### 1.1. プロジェクト概要
「邪雀 Xtreme Mahjong (xmj)」は、「流れ」や「オカルト」といった非合理的な要素や、各種創作麻雀の特殊ルールをテーマにした、新しい形の麻雀ゲームである。プレイヤーは、福本伸行作品に登場するような極限状況での駆け引きや、従来の麻雀にはない戦略的な体験を楽しむことができる。

### 1.2. ゴール
- 既存の麻雀ゲームにはない、緊張感とカオスに満ちた異端の対局体験を提供する。
- サーバー管理コストを最小限に抑えた、P2P中心の技術構成を実現する。
- CUIとブラウザの両方で遊べるクロスプラットフォーム展開を行う。

### 1.3. ターゲットユーザー
- 通常の麻雀に飽きたプレイヤー
- 福本伸行作品（『アカギ』『銀と金』『天』など）のファン
- 駆け引きや心理戦を重視するゲームプレイヤー
- 新しい技術（Nostr, WebRTC）に興味がある開発者・プレイヤー

### 1.4. 機能要件
- **多様なゲームモード:**
  - 誠京麻雀
  - 東西戦（クリア麻雀）
  - 鷲巣麻雀
  - 闇麻
  - リアルタイム麻雀
  - （開発用）通常麻雀
- **プレイヤーモード:**
  - シングルプレイヤー（オフラインCPU戦）
  - マルチプレイヤー（オンライン対戦）
- **オンライン機能:**
  - NostrとWebRTCを利用したP2P対戦
  - 匿名での即時プレイ（アカウント登録不要）
  - 観戦モード
  - チャット機能
  - 戦績記録・グローバルランキング（Nostrイベントベース）

### 1.5. 非機能要件
- **クロスプラットフォーム:** CUI（ターミナル）とWebブラウザで動作する。
- **サーバーレス:** マッチングや状態同期に中央集権的なサーバーを必要としないアーキテクチャを目指す。
- **オフライン動作:** シングルプレイヤーモードはインターネット接続なしで完全に動作する。
- **セキュリティ:** Nostrの署名機能を利用して、なりすましや不正な操作を防止する。
- **リアルタイム性:** オンライン対戦、特にリアルタイム麻雀モードでは低遅延の通信を実現する。

---

## 2. 仕様 (Specifications)

### 2.1. ゲームルール仕様
ログに記載された以下の特殊ルールを実装する。

- **誠京麻雀:** 場代、二度ヅモ、役満祝儀ルール。
- **東西戦:** クリア麻雀（指定された二翻役5つを先に和了したチームが勝利）。
- **鷲巣麻雀:** 3/4が透明なガラス牌、血液（またはポイント）を賭けるルール。
- **闇麻:** 点棒を支払い、打牌を隠す「闇牌」やそれを看破する「照射」などのルール。
- **リアルタイム麻雀:**
  - 全プレイヤーが同時に思考・打牌を行う。
  - 鳴きやロンは早い者勝ち（ロン > ポン > チーの優先順位を適用）。
  - 制限時間内に打牌されない場合は自動でツモ切り。

### 2.2. UI/UX仕様
- **CUI版:**
  - 半角英数字と記号で牌を表現（例: `1m`, `2p`, `to`, `hk`）。風牌（東南西北）と三元牌（白発中）は、`to`, `na`, `sa`, `pe`, `hk`, `ht`, `cn` のように2文字のコードで表現する。
  - 固定幅フォントを前提とし、レイアウトが崩れないようにする。
  - 複数行表示で、手牌、河、点数状況などを分かりやすく表示する。
- **ブラウザ版:**
  - FF14のUIを参考に、画面中央に麻雀卓、下部にログとチャットを融合させた表示領域を設ける。
  - [システムログ]と[プレイヤーチャット]が混在し、リアルタイムな戦場の実況感・カオス感を演出する。
  - フィルター機能（ログのみ/チャットのみ）を搭載し、混乱を避けられるようにする。

### 2.3. AI仕様
- **公平性:** AIはプレイヤーと同じ公開情報（河、ドラ、鳴き、点数状況）と自身の手牌のみを参照し、山牌や他家の手牌を盗み見ることはない。
- **オフライン動作:** AIモデルはクライアントに内蔵し、オフラインで思考・動作を完結させる。
- **戦略:** 確率、統計に基づいた合理的な打牌選択を基本とする。

---

## 3. 設計 (Design)

### 3.1. システムアーキテクチャ
- **コアロジック (Rust):**
  - 麻雀の役判定、点数計算、状態管理など、ゲームの核となるロジックを全てRustで実装する。
  - このコアロジックをWebAssembly (WASM) にコンパイルすることで、CUI版（ネイティブ実行）とブラウザ版（WASM実行）でコードを完全に共通化する。
- **CUIクライアント (Rust):**
  - RustでUI描画とユーザー入力を処理するネイティブアプリケーション。
- **Webクライアント (TypeScript + React/Svelte/Vue):**
  - TypeScriptと任意のUIフレームワークでUIを構築。
  - WASMとしてコンパイルされたRustのコアロジックを呼び出してゲームを進行させる。

### 3.2. 通信設計
オンライン対戦は、NostrとWebRTCを組み合わせたハイブリッドP2Pモデルを採用する。

1.  **マッチング (Nostr):**
    - プレイヤーは「対戦者募集」イベントをNostrリレーに送信する。
    - 他のプレイヤーがイベントを購読し、「応答」イベントを返す。
    - 相互に合意が取れたら、WebRTC接続のためのシグナリング情報（SDP, ICE Candidate）をNostrイベント経由で交換する。
2.  **対戦 (WebRTC):**
    - シグナリング完了後、プレイヤー間でWebRTCのP2P (DataChannel) 接続を確立。
    - 打牌、鳴き、ロンなどのゲーム内イベントは、低遅延なWebRTC経由で直接通信する。通信データは軽量なバイナリ形式を検討する。
3.  **ログ・戦績 (Nostr):**
    - 対戦結果や観戦用のログ、チャット履歴はNostrイベントとしてリレーに投稿する。
    - これにより、クライアント側で集計すればグローバルなランキングや履歴表示が可能になる。

### 3.3. Nostr設計
- **鍵管理:**
  - 初回起動時にクライアントサイドで秘密鍵・公開鍵ペアを自動生成し、ローカルストレージに保存する。ユーザーに鍵を意識させず「即時プレイ」を実現する。
- **イベント設計:**
  - `kind`番号や`tags`を工夫し、ゲームイベントを構造化する。
    - 例: `kind: 30001` (ゲームイベント)
    - `tags: [["d", "game-xmj"], ["gid", "<ゲームID>"], ["type", "discard"], ...]`
  - これにより、無関係なイベントとの混信を防ぎ、特定のゲームのログだけを効率的に購読できるようにする。
- **リレー戦略:**
  - **開発:** ローカルPCで軽量なNostrリレー（nostr-rs-relay等）を起動し、外部に影響を与えずにテストを行う。
  - **本番:** ゲーム専用の公開リレーを立てるか、既存の公開リレーを利用する。その際、イベント量を制御し、リレー運営者に過度な負荷をかけないよう配慮する。

---

---

## 4. 実装進捗 (Implementation Progress)

### ✅ フェーズ1: コアロジックとCUIプロトタイプの開発 (完了: 2025-07-08)

**実装内容:**
1. **Rustで麻雀コアライブラリを実装:**
   - 牌システム（`src/tile.rs`）: 数牌・字牌・赤ドラ対応、文字列変換機能
   - 手牌管理（`src/hand.rs`）: 副露管理、自動ソート、基本和了判定
   - プレイヤー管理（`src/player.rs`）: 点数管理、河（捨て牌）管理
   - ゲーム進行（`src/game.rs`）: 配牌、山牌管理、ドラ表示牌、ターン管理
   - 点数計算（`src/scoring.rs`）: 基本的な役判定・符計算システム

2. **CUIクライアントの作成:**
   - ターミナルベースUI（`src/main.rs`）
   - プレイヤー入力処理（牌の文字列入力: `1m`, `5pr`, `to` など）
   - ゲーム状態表示（手牌、河、点数、ドラ表示）
   - CPU対戦機能（シンプルな思考ルーチン）

3. **技術基盤:**
   - Cargo.toml設定（ライブラリ/バイナリ分離構成）
   - 単体テスト実装
   - 型安全な設計（Rustの所有権システム活用）

**動作確認:**
- ✅ コンパイル成功
- ✅ 基本的なゲームループ動作
- ✅ 牌の表示・入力システム
- ✅ CPU対戦プロトタイプ

**技術的成果:**
- 麻雀の基本ロジックをRustで完全実装
- CUIでの対話的ゲームプレイが可能
- 今後のWebAssembly化、P2P通信への拡張基盤が完成

### 🚧 次期実装予定

**フェーズ2: NostrによるP2P通信の基礎実装**
- Nostrクライアント機能統合 (nostr-sdk)
- 鍵の自動生成・管理
- CUIでのP2P対戦プロトタイプ

**フェーズ3: Web版クライアント開発**
- WASMビルド環境構築
- TypeScript + UIフレームワークでのWebUI
- Web版CPU対戦実装

**フェーズ4: オンライン対戦機能完成**
- WebRTCシグナリング (Nostr経由)
- P2P状態同期システム
- Web版オンライン対戦

**フェーズ5: 特殊ルール実装・機能拡充**
- 鷲巣麻雀・誠京麻雀等の特殊ルール
- リアルタイム麻雀モード
- 観戦・チャット・ランキング機能

---

## 5. 実装の段取り (Implementation Plan)

### フェーズ1: コアロジックとCUIプロトタイプの開発
1.  **Rustで麻雀コアライブラリを実装:**
    - 牌、山、手牌、和了判定、点数計算などの基本的な麻雀ロジックを実装する。
2.  **CUIクライアントの作成:**
    - Rustでターミナル上の描画とキー入力を処理するフロントエンドを作成。
    - コアライブラリと結合し、一人でプレイできる状態（ツモと打牌）にする。
3.  **CPUプレイヤーの実装:**
    - シンプルな思考ルーチンを持つCPUを実装し、CPU対戦ができるようにする。

### フェーズ2: NostrによるP2P通信の基礎を実装
1.  **Nostrクライアント機能の統合:**
    - RustのNostrライブラリ（nostr-sdkなど）を導入。
    - 鍵の自動生成と保存、イベントの送受信機能を実装する。
2.  **CUIでのP2P対戦プロトタイプ:**
    - 2つのCUIクライアントを起動し、Nostrリレーを介して打牌情報などを同期させ、対戦が成立することを確認する。

### フェーズ3: Web版クライアントの開発
1.  **WASMビルド環境の構築:**
    - RustのコアライブラリをWASMにコンパイルするワークフローを整備する。
2.  **Webフロントエンドの作成:**
    - TypeScriptとUIフレームワーク（React等）でUIの骨格を作成。
    - WASMをロードし、Rust側の関数を呼び出せるようにする。
3.  **Web版CPU対戦の実装:**
    - CUI版と同様に、Webブラウザ上でCPU対戦が完結するように実装する。

### フェーズ4: オンライン対戦機能の完成
1.  **WebRTCシグナリングの実装:**
    - Nostrをシグナリングサーバーとして利用し、WebRTCの接続情報を交換するロジックを実装する。
2.  **WebRTCによる状態同期:**
    - P2P接続確立後、DataChannelを使ってゲーム状態をリアルタイムに同期させる。
    - これにより、Webクライアント同士でのオンライン対戦を可能にする。

### フェーズ5: 特殊ルールの実装と機能拡充
1.  **各種特殊ルールの実装:**
    - 鷲巣麻雀、誠京麻雀など、仕様に定義された特殊ルールを一つずつコアロジックに追加していく。
2.  **リアルタイム麻雀モードの実装:**
    - UI/UXと通信方式をリアルタイム用に調整し、新モードとして実装する。
3.  **追加機能の開発:**
    - 観戦モード、チャット機能、Nostrベースの戦績記録・ランキング表示などを実装する。
