<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚ªé›€ - ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #0f0;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px #0f0;
        }

        .panel {
            background: rgba(0, 255, 0, 0.05);
            border: 2px solid #0f0;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .panel h2 {
            color: #0ff;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #0f0;
            color: #0f0;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: rgba(0, 255, 0, 0.2);
        }

        .tab.active {
            background: #0f0;
            color: #000;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #0f0;
        }

        .info-label {
            color: #0ff;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-value {
            color: #0f0;
            font-size: 1.2em;
            word-break: break-all;
        }

        .log {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #0f0;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(0, 255, 0, 0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.success {
            color: #0f0;
        }

        .log-entry.error {
            color: #f00;
        }

        .log-entry.warn {
            color: #ff0;
        }

        .log-entry.info {
            color: #0ff;
        }

        button {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #0f0;
            color: #0f0;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: rgba(0, 255, 0, 0.3);
        }

        button.danger {
            border-color: #f00;
            color: #f00;
        }

        button.danger:hover {
            background: rgba(255, 0, 0, 0.2);
        }

        input[type="text"],
        input[type="number"],
        select {
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            width: 100%;
            margin-bottom: 10px;
        }

        input:focus,
        select:focus {
            outline: none;
            box-shadow: 0 0 10px #0f0;
        }

        .command-box {
            background: #000;
            border: 1px solid #0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .command-box pre {
            color: #0ff;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f00;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #0f0;
            box-shadow: 0 0 10px #0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› é‚ªé›€ ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('overview')">æ¦‚è¦</div>
            <div class="tab" onclick="showTab('nostr')">Nostr</div>
            <div class="tab" onclick="showTab('webrtc')">WebRTC</div>
            <div class="tab" onclick="showTab('game')">ã‚²ãƒ¼ãƒ çŠ¶æ…‹</div>
            <div class="tab" onclick="showTab('tools')">ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«</div>
        </div>

        <!-- æ¦‚è¦ã‚¿ãƒ– -->
        <div class="panel" id="tab-overview">
            <h2>ğŸ” ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">WASM ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                    <div class="info-value" id="wasmVersion">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ã‚²ãƒ¼ãƒ å</div>
                    <div class="info-value" id="gameName">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ãƒ–ãƒ©ã‚¦ã‚¶</div>
                    <div class="info-value" id="browser">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ¥ç¶šçŠ¶æ…‹</div>
                    <div class="info-value">
                        <span class="status-indicator" id="connectionStatus"></span>
                        <span id="connectionText">æœªæ¥ç¶š</span>
                    </div>
                </div>
            </div>

            <h2 style="margin-top: 20px;">ğŸ“‹ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰</h2>
            <div class="command-box">
                <pre>1. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ã§å˜ç‹¬ãƒ†ã‚¹ãƒˆ:
   â†’ hybrid.html ã‚’é–‹ãï¼ˆ1äººé–“ + 3CPUï¼‰

2. P2Pé€šä¿¡ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ:
   â†’ è¤‡æ•°ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ã§matchmaking.htmlã‚’é–‹ã
   â†’ å„ã‚¿ãƒ–ã§ç•°ãªã‚‹NostréµãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹
   â†’ 1ã¤ã®ã‚¿ãƒ–ã§ã€Œãƒãƒƒãƒä½œæˆã€ã€ä»–ã®ã‚¿ãƒ–ã§ã€Œå‚åŠ ã€

3. ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®æ´»ç”¨:
   é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ« (F12) â†’ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¿ãƒ–
   ä»¥ä¸‹ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãŒåˆ©ç”¨å¯èƒ½:
   - window.debugNostrKeys  // Nostréµæƒ…å ±
   - window.debugWebRTC     // WebRTCæ¥ç¶šçŠ¶æ…‹
   - window.debugGameState  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹

4. ãƒ­ãƒ¼ã‚«ãƒ«Nostrãƒªãƒ¬ãƒ¼ã®èµ·å‹•:
   docker run -p 7777:8080 scsibug/nostr-rs-relay
   ã¾ãŸã¯
   ws://localhost:7777 ã«æ¥ç¶šå¯èƒ½ãªãƒªãƒ¬ãƒ¼ã‚’ç”¨æ„</pre>
            </div>
        </div>

        <!-- Nostrã‚¿ãƒ– -->
        <div class="panel" id="tab-nostr" style="display: none;">
            <h2>ğŸ”‘ Nostr éµç®¡ç†</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">å…¬é–‹éµ (npub)</div>
                    <div class="info-value" id="nostrPubkey">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ç§˜å¯†éµ (nsec)</div>
                    <div class="info-value" id="nostrSeckey">********</div>
                </div>
            </div>
            <button onclick="generateNewKeys()">æ–°ã—ã„éµã‚’ç”Ÿæˆ</button>
            <button onclick="showSecretKey()">ç§˜å¯†éµã‚’è¡¨ç¤º</button>
            <button class="danger" onclick="deleteKeys()">éµã‚’å‰Šé™¤</button>

            <h2 style="margin-top: 20px;">ğŸ“¡ ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°</h2>
            <div class="log" id="nostrLog">
                <div class="log-entry info">Nostrãƒ­ã‚°æº–å‚™å®Œäº†</div>
            </div>
        </div>

        <!-- WebRTCã‚¿ãƒ– -->
        <div class="panel" id="tab-webrtc" style="display: none;">
            <h2>ğŸ”— WebRTC æ¥ç¶šçŠ¶æ…‹</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥ç¶šæ•°</div>
                    <div class="info-value" id="webrtcConnections">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«</div>
                    <div class="info-value" id="webrtcChannels">0</div>
                </div>
            </div>

            <h2 style="margin-top: 20px;">ğŸ“Š æ¥ç¶šãƒ­ã‚°</h2>
            <div class="log" id="webrtcLog">
                <div class="log-entry info">WebRTCãƒ­ã‚°æº–å‚™å®Œäº†</div>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚¿ãƒ– -->
        <div class="panel" id="tab-game" style="display: none;">
            <h2>ğŸ® ã‚²ãƒ¼ãƒ çŠ¶æ…‹</h2>
            <button onclick="loadGameState()">çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿</button>
            <button onclick="exportGameState()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>

            <div style="margin-top: 20px;">
                <h3 style="color: #0ff; margin-bottom: 10px;">JSON çŠ¶æ…‹</h3>
                <div class="log" id="gameStateLog">
                    <div class="log-entry info">ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
                </div>
            </div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã‚¿ãƒ– -->
        <div class="panel" id="tab-tools" style="display: none;">
            <h2>ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«</h2>

            <h3 style="color: #0ff; margin: 20px 0 10px 0;">ãƒãƒƒãƒãƒ³ã‚°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h3>
            <div>
                <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°:</label>
                <select id="playerCount">
                    <option value="2">2äºº</option>
                    <option value="3">3äºº</option>
                    <option value="4" selected>4äºº</option>
                </select>
            </div>
            <button onclick="simulateMatching()">ãƒãƒƒãƒãƒ³ã‚°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</button>

            <h3 style="color: #0ff; margin: 20px 0 10px 0;">ãƒ­ã‚°å‡ºåŠ›ãƒ†ã‚¹ãƒˆ</h3>
            <div style="display: flex; gap: 10px;">
                <button onclick="testLog('success')">Success</button>
                <button onclick="testLog('error')">Error</button>
                <button onclick="testLog('warn')">Warning</button>
                <button onclick="testLog('info')">Info</button>
            </div>

            <h3 style="color: #0ff; margin: 20px 0 10px 0;">ãƒ†ã‚¹ãƒˆãƒ­ã‚°</h3>
            <div class="log" id="testLog">
                <div class="log-entry info">ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«æº–å‚™å®Œäº†</div>
            </div>
        </div>
    </div>

    <script type="module">
        import init, {
            WasmNostrKeyManager,
            WasmNostrP2PClient,
            WasmWebRtcP2PManager,
            version,
            gameName
        } from './pkg/xmj_core.js';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        window.debugNostrKeys = null;
        window.debugWebRTC = null;
        window.debugGameState = null;

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(panel => panel.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).style.display = 'block';
        };

        // ãƒ­ã‚°è¿½åŠ 
        function addLog(logId, message, type = 'info') {
            const log = document.getElementById(logId);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // åˆæœŸåŒ–
        init().then(async () => {
            document.getElementById('wasmVersion').textContent = version();
            document.getElementById('gameName').textContent = gameName();
            document.getElementById('browser').textContent = navigator.userAgent.split(' ').slice(-1)[0];

            // Nostréµã®èª­ã¿è¾¼ã¿
            if (WasmNostrKeyManager.hasKeys()) {
                const pubkey = WasmNostrKeyManager.loadKeys();
                document.getElementById('nostrPubkey').textContent = pubkey;
                window.debugNostrKeys = { public: pubkey };
                addLog('nostrLog', 'æ—¢å­˜ã®éµã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
            } else {
                addLog('nostrLog', 'éµãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚', 'warn');
            }

            addLog('testLog', 'WASMåˆæœŸåŒ–å®Œäº†', 'success');
        });

        // Nostréµç®¡ç†
        window.generateNewKeys = function() {
            try {
                const pubkey = WasmNostrKeyManager.generateAndSave();
                document.getElementById('nostrPubkey').textContent = pubkey;
                window.debugNostrKeys = { public: pubkey };
                addLog('nostrLog', 'æ–°ã—ã„éµã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
            } catch (e) {
                addLog('nostrLog', `ã‚¨ãƒ©ãƒ¼: ${e}`, 'error');
            }
        };

        window.showSecretKey = function() {
            if (confirm('ç§˜å¯†éµã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿï¼ˆä»–äººã«è¦‹ã›ãªã„ã§ãã ã•ã„ï¼‰')) {
                // TODO: ç§˜å¯†éµã®å–å¾—æ©Ÿèƒ½ã‚’å®Ÿè£…
                alert('ç§˜å¯†éµã®è¡¨ç¤ºæ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™');
            }
        };

        window.deleteKeys = function() {
            if (confirm('æœ¬å½“ã«éµã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    WasmNostrKeyManager.deleteKeys();
                    document.getElementById('nostrPubkey').textContent = '-';
                    document.getElementById('nostrSeckey').textContent = '********';
                    addLog('nostrLog', 'éµã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                } catch (e) {
                    addLog('nostrLog', `ã‚¨ãƒ©ãƒ¼: ${e}`, 'error');
                }
            }
        };

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        window.loadGameState = function() {
            addLog('gameStateLog', 'ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®èª­ã¿è¾¼ã¿æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™', 'warn');
        };

        window.exportGameState = function() {
            addLog('gameStateLog', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™', 'warn');
        };

        // ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«
        window.simulateMatching = function() {
            const count = document.getElementById('playerCount').value;
            addLog('testLog', `${count}äººãƒãƒƒãƒãƒ³ã‚°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆé–‹å§‹`, 'info');
            addLog('testLog', 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™', 'warn');
        };

        window.testLog = function(type) {
            addLog('testLog', `ã“ã‚Œã¯${type}ãƒ­ã‚°ã®ãƒ†ã‚¹ãƒˆã§ã™`, type);
        };
    </script>
</body>
</html>
