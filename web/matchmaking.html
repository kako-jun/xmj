<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚ªé›€ - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒƒãƒãƒ³ã‚°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h2 {
            color: #4facfe;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .key-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }

        button.danger {
            background: linear-gradient(45deg, #ff6b6b, #c92a2a);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .match-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .match-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .match-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #4facfe;
        }

        .match-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-details {
            flex: 1;
        }

        .match-id {
            font-family: monospace;
            font-size: 0.85em;
            color: #888;
        }

        .player-count {
            color: #4facfe;
            font-weight: bold;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .status.waiting {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
        }

        .status.starting {
            background: rgba(76, 209, 55, 0.2);
            color: #4cd137;
        }

        .status.full {
            background: rgba(245, 87, 108, 0.2);
            color: #f5576c;
        }

        .log {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.info {
            color: #4facfe;
        }

        .log-entry.success {
            color: #4cd137;
        }

        .log-entry.error {
            color: #f5576c;
        }

        .relay-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #888;
        }

        .status-dot.connected {
            background: #4cd137;
            box-shadow: 0 0 10px #4cd137;
        }

        .status-dot.disconnected {
            background: #f5576c;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1em;
            margin-bottom: 10px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #4facfe;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ€„ é‚ªé›€ Xtreme Mahjong</h1>

        <!-- Nostréµæƒ…å ± -->
        <div class="section">
            <h2>ğŸ”‘ ã‚ãªãŸã®è­˜åˆ¥å­</h2>
            <div class="key-info" id="publicKey">éµã‚’ç”Ÿæˆä¸­...</div>
            <div class="relay-status">
                <span class="status-dot" id="relayStatus"></span>
                <span id="relayText">ãƒªãƒ¬ãƒ¼: æœªæ¥ç¶š</span>
            </div>
            <div class="button-group">
                <button onclick="regenerateKeys()" class="danger">ğŸ”„ éµã‚’å†ç”Ÿæˆ</button>
                <button onclick="copyPublicKey()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>

        <!-- ãƒãƒƒãƒãƒ³ã‚°ä½œæˆ -->
        <div class="section">
            <h2>ğŸ® æ–°ã—ã„ãƒãƒƒãƒã‚’ä½œæˆ</h2>
            <div class="button-group">
                <button onclick="createMatch(4)" class="secondary">4äººéº»é›€ã‚’é–‹å§‹</button>
                <button onclick="createMatch(3)" class="secondary">3äººéº»é›€ã‚’é–‹å§‹</button>
            </div>
        </div>

        <!-- ãƒãƒƒãƒãƒ³ã‚°å‚åŠ  -->
        <div class="section">
            <h2>ğŸ” ãƒãƒƒãƒã‚’æ¤œç´¢</h2>
            <button onclick="refreshMatches()">ğŸ”„ æ›´æ–°</button>
            <div class="match-list" id="matchList">
                <p style="text-align: center; color: #888; padding: 20px;">
                    ã€Œæ›´æ–°ã€ã‚’æŠ¼ã—ã¦ãƒãƒƒãƒã‚’æ¤œç´¢
                </p>
            </div>
        </div>

        <!-- ãƒãƒƒãƒIDã§ç›´æ¥å‚åŠ  -->
        <div class="section">
            <h2>ğŸ¯ ãƒãƒƒãƒIDã§å‚åŠ </h2>
            <input type="text" id="matchIdInput" placeholder="ãƒãƒƒãƒIDã‚’å…¥åŠ›">
            <button onclick="joinMatchById()">å‚åŠ </button>
        </div>

        <!-- ãƒ­ã‚° -->
        <div class="section">
            <h2>ğŸ“‹ ãƒ­ã‚°</h2>
            <div class="log" id="log">
                <div class="log-entry info">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•</div>
            </div>
        </div>

        <!-- ãƒ­ãƒ¼ã‚«ãƒ«ã‚²ãƒ¼ãƒ  -->
        <div class="section">
            <h2>ğŸ  ãƒ­ãƒ¼ã‚«ãƒ«ã‚²ãƒ¼ãƒ </h2>
            <button onclick="startLocalGame()">CPUå¯¾æˆ¦ã‚’é–‹å§‹</button>
        </div>
    </div>

    <script type="module">
        import init, {
            WasmNostrKeyManager,
            WasmNostrP2PClient,
            WasmWebRtcP2PManager
        } from './pkg/xmj_core.js';

        let nostrClient = null;
        let webrtcManager = null;
        let myPublicKey = null;

        // ãƒ­ã‚°è¿½åŠ é–¢æ•°
        window.addLog = function(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        };

        // éµã®åˆæœŸåŒ–
        async function initKeys() {
            try {
                if (WasmNostrKeyManager.hasKeys()) {
                    myPublicKey = WasmNostrKeyManager.loadKeys();
                    addLog('æ—¢å­˜ã®éµã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                } else {
                    myPublicKey = WasmNostrKeyManager.generateAndSave();
                    addLog('æ–°ã—ã„éµã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
                }

                document.getElementById('publicKey').textContent = myPublicKey;

                // Nostrã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
                const relayUrl = 'ws://localhost:7777'; // ãƒ­ãƒ¼ã‚«ãƒ«ãƒªãƒ¬ãƒ¼
                nostrClient = new WasmNostrP2PClient(relayUrl);

                // WebRTCãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
                webrtcManager = new WasmWebRtcP2PManager(myPublicKey);

                updateRelayStatus(true);
                addLog('Nostrãƒªãƒ¬ãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ', 'success');
            } catch (e) {
                addLog(`ã‚¨ãƒ©ãƒ¼: ${e}`, 'error');
                updateRelayStatus(false);
            }
        }

        // ãƒªãƒ¬ãƒ¼çŠ¶æ…‹ã®æ›´æ–°
        function updateRelayStatus(connected) {
            const dot = document.getElementById('relayStatus');
            const text = document.getElementById('relayText');

            if (connected) {
                dot.className = 'status-dot connected';
                text.textContent = 'ãƒªãƒ¬ãƒ¼: æ¥ç¶šæ¸ˆã¿ (ws://localhost:7777)';
            } else {
                dot.className = 'status-dot disconnected';
                text.textContent = 'ãƒªãƒ¬ãƒ¼: æœªæ¥ç¶š';
            }
        }

        // å…¬é–‹éµã®ã‚³ãƒ”ãƒ¼
        window.copyPublicKey = function() {
            navigator.clipboard.writeText(myPublicKey).then(() => {
                addLog('å…¬é–‹éµã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            });
        };

        // éµã®å†ç”Ÿæˆ
        window.regenerateKeys = function() {
            if (confirm('æœ¬å½“ã«æ–°ã—ã„éµã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®éµã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
                try {
                    WasmNostrKeyManager.deleteKeys();
                    myPublicKey = WasmNostrKeyManager.generateAndSave();
                    document.getElementById('publicKey').textContent = myPublicKey;
                    addLog('æ–°ã—ã„éµã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
                } catch (e) {
                    addLog(`ã‚¨ãƒ©ãƒ¼: ${e}`, 'error');
                }
            }
        };

        // ãƒãƒƒãƒä½œæˆ
        window.createMatch = function(maxPlayers) {
            if (!nostrClient) {
                addLog('Nostrã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const eventJson = nostrClient.createMatchSeekEvent(maxPlayers);
                const event = JSON.parse(eventJson);
                addLog(`${maxPlayers}äººéº»é›€ãƒãƒƒãƒã‚’ä½œæˆã—ã¾ã—ãŸ`, 'success');
                addLog(`ãƒãƒƒãƒID: ${event.match_id}`, 'info');

                // TODO: Nostrãƒªãƒ¬ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’Publish
                // ã“ã®éƒ¨åˆ†ã¯å®Ÿéš›ã®Nostrå®Ÿè£…ãŒå¿…è¦
            } catch (e) {
                addLog(`ã‚¨ãƒ©ãƒ¼: ${e}`, 'error');
            }
        };

        // ãƒãƒƒãƒä¸€è¦§ã®æ›´æ–°
        window.refreshMatches = function() {
            addLog('ãƒãƒƒãƒã‚’æ¤œç´¢ä¸­...', 'info');

            // TODO: Nostrãƒªãƒ¬ãƒ¼ã‹ã‚‰ãƒãƒƒãƒä¸€è¦§ã‚’å–å¾—
            // ãƒ‡ãƒ¢ç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
            const matches = [
                {
                    match_id: 'demo-match-001',
                    host_pubkey: 'npub1234...5678',
                    players: ['Player1', 'Player2'],
                    max_players: 4,
                    status: 'waiting'
                }
            ];

            displayMatches(matches);
        };

        // ãƒãƒƒãƒä¸€è¦§ã®è¡¨ç¤º
        function displayMatches(matches) {
            const list = document.getElementById('matchList');

            if (matches.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">ãƒãƒƒãƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            list.innerHTML = '';
            matches.forEach(match => {
                const item = document.createElement('div');
                item.className = 'match-item';

                const playerCount = match.players.length;
                const statusClass = playerCount >= match.max_players ? 'full' :
                                  playerCount > 0 ? 'starting' : 'waiting';
                const statusText = playerCount >= match.max_players ? 'æº€å¸­' :
                                 playerCount > 0 ? 'å‹Ÿé›†ä¸­' : 'å¾…æ©Ÿä¸­';

                item.innerHTML = `
                    <div class="match-info">
                        <div class="match-details">
                            <div class="match-id">ID: ${match.match_id}</div>
                            <div class="player-count">
                                ${playerCount} / ${match.max_players} äºº
                            </div>
                            <div class="status ${statusClass}">${statusText}</div>
                        </div>
                        ${playerCount < match.max_players ?
                            `<button onclick="joinMatch('${match.match_id}')">å‚åŠ </button>` :
                            `<button disabled>æº€å¸­</button>`}
                    </div>
                `;

                list.appendChild(item);
            });
        }

        // ãƒãƒƒãƒã«å‚åŠ 
        window.joinMatch = function(matchId) {
            if (!nostrClient) {
                addLog('Nostrã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const eventJson = nostrClient.createMatchJoinEvent(matchId);
                addLog(`ãƒãƒƒãƒ ${matchId} ã«å‚åŠ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ`, 'success');

                // TODO: Nostrãƒªãƒ¬ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’Publish
                // TODO: WebRTCæ¥ç¶šã®ç¢ºç«‹
            } catch (e) {
                addLog(`ã‚¨ãƒ©ãƒ¼: ${e}`, 'error');
            }
        };

        // IDã§ãƒãƒƒãƒã«å‚åŠ 
        window.joinMatchById = function() {
            const matchId = document.getElementById('matchIdInput').value.trim();
            if (!matchId) {
                addLog('ãƒãƒƒãƒIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            joinMatch(matchId);
        };

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚²ãƒ¼ãƒ é–‹å§‹
        window.startLocalGame = function() {
            window.location.href = 'index.html';
        };

        // åˆæœŸåŒ–
        init().then(() => {
            addLog('WASMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
            initKeys();
        }).catch(e => {
            addLog(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${e}`, 'error');
        });
    </script>
</body>
</html>
